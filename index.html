<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek RPG: OpenRouter Edition</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --terminal-bg: #000;
            --text-color: #33ff00;
            --user-text: #00e5ff;
            --dim-text: #2d5e2d;
            --error-text: #ff3333;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .crt-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--terminal-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
            border: 1px solid #333;
        }

        .crt-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        header {
            padding: 15px;
            border-bottom: 1px solid var(--dim-text);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
        }

        #game-log {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .message { margin-bottom: 15px; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dm-msg { color: var(--text-color); }
        .user-msg { color: var(--user-text); text-align: right; }
        .error-msg { color: var(--error-text); border: 1px solid var(--error-text); padding: 10px; }

        .input-area {
            padding: 20px;
            border-top: 1px solid var(--dim-text);
            display: flex;
            gap: 10px;
            background: #000;
            z-index: 20;
        }

        input[type="text"] {
            flex: 1;
            background: #111;
            border: 1px solid var(--dim-text);
            color: var(--text-color);
            padding: 10px;
            font-family: inherit;
            font-size: 16px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--text-color); }

        button {
            background: var(--dim-text);
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: var(--text-color); }
        button:disabled { background: #333; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="crt-container">
    <div class="crt-overlay"></div>
    <header>DeepSeek RPG // OPENROUTER LINK</header>
    
    <div id="game-log">
        <div class="message dm-msg">>> SYSTEM: Ключ OpenRouter обнаружен.</div>
        <div class="message dm-msg">>> SYSTEM: Канал связи стабилен.</div>
        <div class="message dm-msg">В каком жанре начнем игру? (Киберпанк, Фэнтези, Сталкер, Хоррор)</div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Введите жанр..." autocomplete="off">
        <button id="send-btn">⏎</button>
    </div>
</div>

<script>
    // --- ВАШ НОВЫЙ КЛЮЧ ---
    const API_KEY = "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";
    
    // Используем OpenRouter, так как ключ формата sk-or-v1...
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";
    
    let conversationHistory = [
        {
            role: "system",
            content: "Ты — ведущий текстовой RPG (Dungeon Master). Иди сразу к делу. Описывай ситуации кратко, но атмосферно. Не используй списки, пиши художественным текстом. Всегда заканчивай вопросом: 'Что будешь делать?'."
        },
        {
            role: "assistant",
            content: "Система готова. Выберите жанр."
        }
    ];

    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    function appendMessage(sender, text, isError = false) {
        const div = document.createElement('div');
        div.classList.add('message');
        if (isError) {
            div.classList.add('error-msg');
        } else {
            div.classList.add(sender === 'User' ? 'user-msg' : 'dm-msg');
        }
        
        div.innerText = isError ? text : `[${sender}]: ${text}`;
        gameLog.appendChild(div);
        gameLog.scrollTop = gameLog.scrollHeight;
    }

    async function makeMove() {
        const text = userInput.value.trim();
        if (!text) return;

        appendMessage("User", text);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;
        sendBtn.innerText = "...";

        conversationHistory.push({ role: "user", content: text });

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_KEY}`,
                    "HTTP-Referer": window.location.href, // Требуется для OpenRouter
                    "X-Title": "DeepSeek RPG" // Требуется для OpenRouter
                },
                body: JSON.stringify({
                    // Указываем модель DeepSeek через OpenRouter
                    model: "deepseek/deepseek-chat", 
                    messages: conversationHistory,
                    temperature: 1.1,
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                console.error(errData);
                throw new Error(`Ошибка сервера ${response.status}: ${errData.error?.message || 'Неизвестная ошибка'}`);
            }

            const data = await response.json();
            
            // Защита от пустого ответа
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                 throw new Error("Пустой ответ от API");
            }

            const botReply = data.choices[0].message.content;

            appendMessage("DM", botReply);
            conversationHistory.push({ role: "assistant", content: botReply });

        } catch (error) {
            appendMessage("SYSTEM", error.message, true);
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.innerText = "⏎";
            userInput.focus();
        }
    }

    sendBtn.addEventListener('click', makeMove);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') makeMove();
    });
    
    userInput.focus();

</script>
</body>
</html>
