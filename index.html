<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>\\ DeepSeek RPG //</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --terminal-bg: #000;
            --text-color: #33ff00; /* Зеленый терминал */
            --user-text: #00e5ff;   /* Голубой текст юзера */
            --dim-text: #2d5e2d;
            --highlight: #adff2f;
            --btn-bg: #112211;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-color);
            height: 100vh; /* На весь экран */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Скроллится только чат */
        }

        /* Шапка */
        header {
            background: #111;
            padding: 10px 15px;
            border-bottom: 1px solid var(--dim-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--highlight);
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #reset-btn {
            background: #330000;
            color: #ff5555;
            border: 1px solid #550000;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Область чата */
        #game-log {
            flex: 1; /* Занимает всё доступное место */
            padding: 15px;
            overflow-y: auto; /* Скролл только здесь */
            background-color: var(--terminal-bg);
            font-size: 16px;
            line-height: 1.5;
            -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
        }

        .message {
            margin-bottom: 15px;
            max-width: 100%;
            word-wrap: break-word;
        }

        .dm-msg { color: var(--text-color); }
        .user-msg { 
            color: var(--user-text); 
            text-align: right; 
            background: rgba(0, 229, 255, 0.05);
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 20%;
        }
        .error-msg { color: #ff5555; border: 1px solid #ff5555; padding: 5px; }

        /* Область управления (низ) */
        .controls-area {
            background: #050505;
            border-top: 1px solid var(--dim-text);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Кнопки вариантов */
        #choices-container {
            display: flex;
            flex-direction: column; /* Вертикальный список для мобилок */
            gap: 8px;
        }

        .choice-btn {
            background: var(--btn-bg);
            border: 1px solid var(--dim-text);
            color: var(--highlight);
            padding: 12px;
            font-family: inherit;
            font-size: 15px;
            text-align: left;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
            /* Для мобилок: убираем синюю подсветку при тапе */
            -webkit-tap-highlight-color: transparent;
        }

        .choice-btn:active { background: #003300; transform: scale(0.98); }

        /* Поле ввода */
        .input-row {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid var(--dim-text);
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 16px; /* 16px чтобы iOS не зумил */
            outline: none;
        }

        input[type="text"]:focus { border-color: var(--highlight); }

        #send-btn {
            background: var(--dim-text);
            color: black;
            border: none;
            padding: 0 20px;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <span>DEEPSEEK RPG</span>
    <button id="reset-btn" title="Сбросить игру">↻ NEW GAME</button>
</header>

<div id="game-log">
    </div>

<div class="controls-area">
    <div id="choices-container">
        </div>

    <div class="input-row">
        <input type="text" id="user-input" placeholder="Ваше действие..." autocomplete="off">
        <button id="send-btn">⏎</button>
    </div>
</div>

<script>
    // --- НАСТРОЙКИ ---
    const API_KEY = "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";
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";
    const MODEL_ID = "tngtech/deepseek-r1t2-chimera:free"; 
    const STORAGE_KEY = "deepseek_rpg_save_v2"; // Ключ для сохранения

    // Стандартный старт
    const SYSTEM_PROMPT = `
    Ты — Dungeon Master (Ведущий). Твоя задача: вести текстовую RPG на русском языке.
    Твой ответ ВСЕГДА должен быть в формате JSON.
    Структура JSON:
    {
        "story": "Текст ситуации (атмосферный, до 400 символов).",
        "options": ["Вариант 1", "Вариант 2", "Вариант 3"]
    }
    `;

    // --- ПЕРЕМЕННЫЕ ---
    let conversationHistory = [];
    
    // Элементы
    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const choicesContainer = document.getElementById('choices-container');
    const resetBtn = document.getElementById('reset-btn');

    // --- ЗАГРУЗКА ИСТОРИИ ---
    function init() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            // Восстанавливаем игру
            const parsed = JSON.parse(savedData);
            conversationHistory = parsed.history;
            
            // Отрисовываем чат заново
            gameLog.innerHTML = '';
            parsed.uiLog.forEach(item => {
                appendMessageToUI(item.sender, item.text);
            });
            
            // Восстанавливаем последние кнопки
            if (parsed.lastOptions) {
                renderButtons(parsed.lastOptions);
            }
        } else {
            // Новая игра
            startNewGame();
        }
    }

    function startNewGame() {
        localStorage.removeItem(STORAGE_KEY);
        gameLog.innerHTML = '';
        choicesContainer.innerHTML = '';
        conversationHistory = [{ role: "system", content: SYSTEM_PROMPT }];
        
        appendMessageToUI('DM', 'Система готова. Выберите жанр:');
        renderButtons(['Киберпанк', 'Хоррор', 'Фэнтези', 'Зомби']);
        saveGame(['Киберпанк', 'Хоррор', 'Фэнтези', 'Зомби']);
    }

    // --- ФУНКЦИИ UI ---
    function appendMessageToUI(sender, text) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(sender === 'User' ? 'user-msg' : 'dm-msg');
        div.innerHTML = text.replace(/\n/g, '<br>');
        gameLog.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        gameLog.scrollTop = gameLog.scrollHeight;
    }

    function renderButtons(options) {
        choicesContainer.innerHTML = ''; 
        if (!options || !Array.isArray(options)) return;
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.classList.add('choice-btn');
            btn.innerText = `> ${opt}`;
            btn.onclick = () => handleChoice(opt);
            choicesContainer.appendChild(btn);
        });
        scrollToBottom(); // Чтобы кнопки были видны
    }

    // --- СОХРАНЕНИЕ ---
    function saveGame(currentOptions = []) {
        // Мы сохраняем и техническую историю (для API) и визуальную (для глаза)
        const uiLog = [];
        document.querySelectorAll('.message').forEach(el => {
            uiLog.push({
                sender: el.classList.contains('user-msg') ? 'User' : 'DM',
                text: el.innerHTML // innerHTML сохраняет <br>
            });
        });

        const saveData = {
            history: conversationHistory,
            uiLog: uiLog,
            lastOptions: currentOptions
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
    }

    // --- ЛОГИКА ИГРЫ ---
    async function handleChoice(text) {
        if (!text) return;
        
        // 1. Отображаем выбор
        appendMessageToUI("User", text);
        userInput.value = '';
        choicesContainer.innerHTML = ''; // Скрываем кнопки
        setLoading(true);

        // 2. Добавляем в историю API
        conversationHistory.push({ role: "user", content: text });

        try {
            // 3. Запрос
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_KEY}`,
                    "HTTP-Referer": window.location.href,
                    "X-Title": "Mobile RPG"
                },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: conversationHistory,
                    temperature: 0.8
                })
            });

            if (!response.ok) throw new Error("Ошибка связи с сервером");
            const data = await response.json();
            const rawContent = data.choices[0].message.content;

            // 4. Парсинг JSON (Умный поиск)
            let result;
            try {
                const jsonStart = rawContent.indexOf('{');
                const jsonEnd = rawContent.lastIndexOf('}');
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const jsonString = rawContent.substring(jsonStart, jsonEnd + 1);
                    result = JSON.parse(jsonString);
                } else { throw new Error("No JSON"); }
            } catch {
                result = { 
                    story: rawContent, 
                    options: ["Продолжить", "Осмотреться"] 
                };
            }

            // 5. Вывод
            appendMessageToUI("DM", result.story || "...");
            renderButtons(result.options);
            
            // 6. Обновление истории и Сохранение
            conversationHistory.push({ role: "assistant", content: rawContent });
            saveGame(result.options);

        } catch (error) {
            appendMessageToUI("DM", `<span style='color:red'>Ошибка: ${error.message}</span>`);
            renderButtons(["Попробовать снова"]);
        } finally {
            setLoading(false);
        }
    }

    function setLoading(isLoading) {
        userInput.disabled = isLoading;
        sendBtn.disabled = isLoading;
        sendBtn.innerText = isLoading ? "..." : "⏎";
        if (!isLoading) {
            setTimeout(() => userInput.focus(), 100); // Небольшая задержка для мобилок
        }
    }

    // --- СОБЫТИЯ ---
    sendBtn.onclick = () => handleChoice(userInput.value.trim());
    userInput.onkeypress = (e) => { if(e.key === 'Enter') handleChoice(userInput.value.trim()); };
    
    resetBtn.onclick = () => {
        if(confirm("Начать новую историю? Текущий прогресс удалится.")) {
            startNewGame();
        }
    };

    // Запуск
    init();

</script>
</body>
</html>
