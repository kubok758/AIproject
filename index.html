<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek RPG: Chimera Edition</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --terminal-bg: #000;
            --text-color: #33ff00;
            --user-text: #00e5ff;
            --dim-text: #2d5e2d;
            --highlight: #adff2f;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .crt-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--terminal-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
            border: 1px solid #333;
        }

        .crt-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        header {
            padding: 15px;
            border-bottom: 1px solid var(--dim-text);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            color: var(--highlight);
        }

        #game-log {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .message { margin-bottom: 20px; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dm-msg { color: var(--text-color); }
        .user-msg { color: var(--user-text); text-align: right; border-right: 2px solid var(--user-text); padding-right: 10px; }
        .error-msg { color: #ff3333; border: 1px solid #ff3333; padding: 10px; background: rgba(50,0,0,0.5); }

        #choices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 20px 15px 20px;
            min-height: 50px;
            justify-content: flex-end;
            z-index: 20;
        }

        .choice-btn {
            background: #001100;
            border: 1px solid var(--dim-text);
            color: var(--highlight);
            padding: 10px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: 0.2s;
            text-align: left;
        }

        .choice-btn:hover {
            border-color: var(--highlight);
            background: #002200;
            box-shadow: 0 0 10px var(--dim-text);
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid var(--dim-text);
            display: flex;
            gap: 10px;
            background: #000;
            z-index: 20;
        }

        input[type="text"] {
            flex: 1;
            background: #111;
            border: 1px solid var(--dim-text);
            color: var(--text-color);
            padding: 10px;
            font-family: inherit;
            font-size: 16px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--highlight); }

        button#send-btn {
            background: var(--dim-text);
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        button#send-btn:disabled { background: #333; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="crt-container">
    <div class="crt-overlay"></div>
    <header>DeepSeek R1T2 // CHIMERA RPG</header>
    
    <div id="game-log">
        <div class="message dm-msg">>> SYSTEM: Подключение к модулю Chimera (Free)...</div>
        <div class="message dm-msg">>> SYSTEM: Связь установлена.</div>
        <div class="message dm-msg">В каком жанре начнем игру?</div>
    </div>

    <div id="choices-container">
        <button class="choice-btn" onclick="handleChoice('Киберпанк')">1. Киберпанк</button>
        <button class="choice-btn" onclick="handleChoice('Хоррор в космосе')">2. Хоррор в космосе</button>
        <button class="choice-btn" onclick="handleChoice('Постапокалипсис')">3. Постапокалипсис</button>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Ваше действие..." autocomplete="off">
        <button id="send-btn">⏎</button>
    </div>
</div>

<script>
    // --- НАСТРОЙКИ ---
    const API_KEY = "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";
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";
    // Используем бесплатную модель из вашего списка:
    const MODEL_ID = "tngtech/deepseek-r1t2-chimera:free"; 

    const SYSTEM_PROMPT = `
    Ты — Dungeon Master (Ведущий). Твоя задача: вести текстовую RPG на русском языке.
    
    ВАЖНО: Твой ответ ВСЕГДА должен быть в формате JSON. Не пиши никакого вступления, только JSON.
    
    Структура JSON:
    {
        "story": "Текст ситуации (атмосферный, но лаконичный, до 500 символов).",
        "options": ["Вариант действия 1", "Вариант действия 2", "Вариант действия 3"]
    }

    Если пользователь говорит не по теме, обыграй это в сюжете или верни игру в русло.
    `;

    let conversationHistory = [
        { role: "system", content: SYSTEM_PROMPT }
    ];

    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const choicesContainer = document.getElementById('choices-container');

    function appendMessage(sender, text, isError = false) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isError ? 'error-msg' : (sender === 'User' ? 'user-msg' : 'dm-msg'));
        div.innerHTML = isError ? text : `[${sender}]: ${text.replace(/\n/g, '<br>')}`;
        gameLog.appendChild(div);
        gameLog.scrollTop = gameLog.scrollHeight;
    }

    function renderButtons(options) {
        choicesContainer.innerHTML = ''; 
        if (!options || !Array.isArray(options)) return;
        
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.classList.add('choice-btn');
            btn.innerText = `> ${opt}`;
            btn.onclick = () => handleChoice(opt);
            choicesContainer.appendChild(btn);
        });
    }

    async function handleChoice(text) {
        if (!text) return;
        
        appendMessage("User", text);
        userInput.value = '';
        choicesContainer.innerHTML = ''; 
        setLoading(true);

        conversationHistory.push({ role: "user", content: text });

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_KEY}`,
                    "HTTP-Referer": window.location.href,
                    "X-Title": "Chimera RPG"
                },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: conversationHistory,
                    temperature: 0.8, // Чуть ниже, чтобы формат не ломался
                    // Убрали response_format, так как бесплатные модели могут его не поддерживать
                })
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Ошибка API ${response.status}: ${errText}`);
            }

            const data = await response.json();
            
            if (!data.choices || !data.choices[0]) {
                 throw new Error("Пустой ответ от нейросети");
            }

            const rawContent = data.choices[0].message.content;

            // --- Умный парсинг JSON ---
            let result;
            try {
                // Ищем первую фигурную скобку и последнюю
                const jsonStart = rawContent.indexOf('{');
                const jsonEnd = rawContent.lastIndexOf('}');
                
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const jsonString = rawContent.substring(jsonStart, jsonEnd + 1);
                    result = JSON.parse(jsonString);
                } else {
                    throw new Error("JSON не найден");
                }
            } catch (e) {
                console.warn("Ошибка парсинга JSON, используем raw text:", e);
                // Если модель вернула просто текст, а не JSON
                result = {
                    story: rawContent,
                    options: ["Продолжить", "Осмотреться", "Попробовать что-то еще"]
                };
            }

            appendMessage("DM", result.story || "...");
            renderButtons(result.options);
            
            // Сохраняем ответ ассистента
            conversationHistory.push({ role: "assistant", content: rawContent });

        } catch (error) {
            appendMessage("SYSTEM", error.message, true);
            renderButtons(["Попробовать снова"]);
        } finally {
            setLoading(false);
        }
    }

    function setLoading(isLoading) {
        userInput.disabled = isLoading;
        sendBtn.disabled = isLoading;
        sendBtn.innerText = isLoading ? "..." : "⏎";
        if (!isLoading) userInput.focus();
    }

    sendBtn.addEventListener('click', () => handleChoice(userInput.value.trim()));
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChoice(userInput.value.trim());
    });

</script>
</body>
</html>
