<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek RPG: Interactive</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --terminal-bg: #000;
            --text-color: #33ff00;
            --user-text: #00e5ff;
            --dim-text: #2d5e2d;
            --highlight: #adff2f;
            --btn-bg: #1a1a1a;
            --btn-border: #33ff00;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .crt-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--terminal-bg);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(51, 255, 0, 0.2);
            border: 1px solid #333;
        }

        .crt-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 10;
        }

        header {
            padding: 15px;
            border-bottom: 1px solid var(--dim-text);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            color: var(--highlight);
        }

        #game-log {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-size: 16px;
            line-height: 1.6;
            scroll-behavior: smooth;
            padding-bottom: 10px;
        }

        .message { margin-bottom: 20px; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .dm-msg { color: var(--text-color); text-shadow: 0 0 2px var(--dim-text); }
        .user-msg { color: var(--user-text); text-align: right; border-right: 2px solid var(--user-text); padding-right: 10px; }
        .error-msg { color: #ff3333; border: 1px solid #ff3333; padding: 10px; }

        /* Секция с кнопками выборов */
        #choices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 20px 15px 20px;
            min-height: 50px;
            justify-content: flex-end;
        }

        .choice-btn {
            background: var(--bg-color);
            border: 1px solid var(--dim-text);
            color: var(--highlight);
            padding: 8px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            transition: 0.2s;
            text-align: left;
            max-width: 100%;
            z-index: 20;
        }

        .choice-btn:hover {
            border-color: var(--highlight);
            background: #112211;
            box-shadow: 0 0 10px var(--dim-text);
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #333;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid var(--dim-text);
            display: flex;
            gap: 10px;
            background: #000;
            z-index: 20;
        }

        input[type="text"] {
            flex: 1;
            background: #111;
            border: 1px solid var(--dim-text);
            color: var(--text-color);
            padding: 10px;
            font-family: inherit;
            font-size: 16px;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--highlight); }

        button#send-btn {
            background: var(--dim-text);
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
        }
        button#send-btn:hover { background: var(--highlight); }
        button#send-btn:disabled { background: #333; }
    </style>
</head>
<body>

<div class="crt-container">
    <div class="crt-overlay"></div>
    <header>DeepSeek RPG // INTERACTIVE</header>
    
    <div id="game-log">
        <div class="message dm-msg">>> SYSTEM: Нейро-ядро подключено.</div>
        <div class="message dm-msg">Выберите жанр для инициализации симуляции:</div>
    </div>

    <div id="choices-container">
        <button class="choice-btn" onclick="handleChoice('Киберпанк')">1. Киберпанк</button>
        <button class="choice-btn" onclick="handleChoice('Космический Хоррор')">2. Космический Хоррор</button>
        <button class="choice-btn" onclick="handleChoice('Темное Фэнтези')">3. Темное Фэнтези</button>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Или введите свое действие..." autocomplete="off">
        <button id="send-btn">⏎</button>
    </div>
</div>

<script>
    // --- КЛЮЧ ---
    const API_KEY = "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";
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";
    
    // ВАЖНО: Системная инструкция теперь требует JSON
    const SYSTEM_PROMPT = `
    Ты — Dungeon Master в текстовой игре. 
    ТВОЯ ЗАДАЧА: Вести игру, описывать ситуации и предлагать выбор.
    
    ФОРМАТ ОТВЕТА (СТРОГИЙ JSON):
    Ты ОБЯЗАН отвечать ТОЛЬКО валидным JSON объектом без лишнего текста и без markdown блоков.
    Структура JSON:
    {
        "story": "Здесь твое художественное описание ситуации (максимум 400 символов).",
        "options": ["Короткий вариант действия 1", "Короткий вариант действия 2", "Короткий вариант действия 3"]
    }
    
    Никогда не выходи из роли. Язык: Русский.
    `;

    let conversationHistory = [
        { role: "system", content: SYSTEM_PROMPT }
    ];

    const gameLog = document.getElementById('game-log');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const choicesContainer = document.getElementById('choices-container');

    // Функция прокрутки вниз
    function scrollToBottom() {
        gameLog.scrollTop = gameLog.scrollHeight;
    }

    // Добавление сообщения в чат
    function appendMessage(sender, text, isError = false) {
        const div = document.createElement('div');
        div.classList.add('message');
        div.classList.add(isError ? 'error-msg' : (sender === 'User' ? 'user-msg' : 'dm-msg'));
        
        // Обработка переносов строк
        div.innerHTML = isError ? text : `[${sender}]: ${text.replace(/\n/g, '<br>')}`;
        gameLog.appendChild(div);
        scrollToBottom();
    }

    // Рендер кнопок выбора
    function renderButtons(options) {
        choicesContainer.innerHTML = ''; // Очищаем старые
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.classList.add('choice-btn');
            btn.innerText = `> ${opt}`;
            btn.onclick = () => handleChoice(opt);
            choicesContainer.appendChild(btn);
        });
    }

    // Обработка клика по кнопке или ввода текста
    async function handleChoice(text) {
        if (!text) return;
        
        // 1. Интерфейс
        appendMessage("User", text);
        userInput.value = '';
        setLoadingState(true);
        choicesContainer.innerHTML = ''; // Убираем кнопки, пока думает

        // 2. Добавляем в историю
        conversationHistory.push({ role: "user", content: text });

        // 3. Запрос к API
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${API_KEY}`,
                    "HTTP-Referer": window.location.href,
                    "X-Title": "DeepSeek RPG"
                },
                body: JSON.stringify({
                    model: "deepseek/deepseek-chat",
                    messages: conversationHistory,
                    temperature: 1.1, // Креативность
                    response_format: { type: "json_object" } // Просим JSON явно (если API поддерживает)
                })
            });

            if (!response.ok) throw new Error("Ошибка сервера: " + response.status);

            const data = await response.json();
            const rawContent = data.choices[0].message.content;

            // 4. Парсинг ответа (попытка извлечь JSON)
            let parsedResponse;
            try {
                // Иногда ИИ пишет ```json ... ```, чистим это
                const cleanJson = rawContent.replace(/```json/g, '').replace(/```/g, '').trim();
                parsedResponse = JSON.parse(cleanJson);
            } catch (e) {
                console.error("Ошибка парсинга JSON:", e);
                // Если ИИ сломался и вернул просто текст
                parsedResponse = {
                    story: rawContent,
                    options: ["Продолжить", "Осмотреться"]
                };
            }

            // 5. Вывод результата
            appendMessage("DM", parsedResponse.story);
            renderButtons(parsedResponse.options || []);
            
            // Сохраняем ответ ассистента в историю, но в виде строки
            conversationHistory.push({ role: "assistant", content: rawContent });

        } catch (error) {
            appendMessage("SYSTEM", error.message, true);
            // Кнопка восстановления
            renderButtons(["Попробовать снова"]);
        } finally {
            setLoadingState(false);
        }
    }

    // Управление состоянием загрузки
    function setLoadingState(isLoading) {
        userInput.disabled = isLoading;
        sendBtn.disabled = isLoading;
        sendBtn.innerText = isLoading ? "..." : "⏎";
        if (!isLoading) userInput.focus();
    }

    // Слушатели событий ввода
    sendBtn.addEventListener('click', () => handleChoice(userInput.value.trim()));
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleChoice(userInput.value.trim());
    });

</script>
</body>
</html>
